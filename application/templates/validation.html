<!DOCTYPE html>
<html lang="en">

<head>
    <title>buildingSMART IFC Validation Service</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <script type="text/javascript">
        var isIE = !!window.MSInputMethodContext;
        if (isIE) {
            document.write('<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>');
            document.write('<script type="text/javascript" src="/static/lib/fetch.umd.js"><\/script>');
        }
    </script>

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='validation.css') }}">

<body>

    <div class="header">

        <a href="/" style="padding-left: 5px;" id="logo">
            <img class="bsdd-logo"
                src="{{url_for('static', filename='navbar/buildingSMART_RGB_bSDD_service.png')}}" />
        </a>
        <div id="logo">
            <img src="{{url_for('static', filename='navbar/BuildingSmart-login.png')}}" />
        </div>
    
    </div>

    <div id="main">

        <table>
            <tr>
                <th>Syntax</th>
                <th>Schema</th>
                <th>MVD</th>
                <th>bSDD</th>
                <th>IDS</th>
                <th>File format</th>
 
            </tr>
            {% for i in range(0, n_files) %}
                {% set percentageid = "percentage" + i|string %}
                {% set barid = "bar" + i|string %}
                {% set fn = filenames[i]|string %}
                
                {% set format = filenames[i][-3::]|string %}

                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><img src="/static/icons/ifc.png" /></td>

                    <td style="color:royalblue;font-weight: bold;">{{fn}}</td>
                    <td></td>
                    <td>

                        <div class='progress'>
                            <div id={{barid}} class='bar'></div>
                        </div>

                    </td>
                    <td>
                        <div id={{percentageid}} class='percentage' style="color:rgb(105, 125, 239);"></div>
                    </td>
                    <td style="color:rgb(224, 101, 101); font-weight: bold;">Stop</td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <script>

        const processed_files = new Set();
        icons = {'v':'valid', 'w':'warning', 'i':'invalid', 'n':'not'}

        function completeTable(i, results, ids, rows) {

            fetch("/reslogs/" + i + "/" + ids).then(function (r) { return r.json(); }).then(function (r) {
                
                var syntaxImg = document.createElement("img");
                syntaxImg.src = "/static/icons/"+ icons[r["results"]['syntaxlog']]+".png";

                var schemaImg = document.createElement("img");
                schemaImg.src = "/static/icons/"+ icons[r["results"]['schemalog']]+".png";

                var MVDImg = document.createElement("img");
                MVDImg.src = "/static/icons/"+ icons[r["results"]['mvdlog']]+".png";

                var bsddImg = document.createElement("img");
                bsddImg.src = "/static/icons/"+ icons[r["results"]['bsddlog']]+".png";

                var idsImg = document.createElement("img");
                idsImg.src = "/static/icons/"+ icons[r["results"]['idslog']]+".png";

                rows[i + 1].cells[0].appendChild(syntaxImg);
                rows[i + 1].cells[1].appendChild(schemaImg);
                rows[i + 1].cells[2].appendChild(MVDImg);
                rows[i + 1].cells[3].appendChild(bsddImg);
                rows[i + 1].cells[4].appendChild(idsImg);

                rows[i + 1].cells[8].innerHTML = r["time"];
                rows[i + 1].cells[8].style.fontWeight = "bold";
                rows[i + 1].cells[8].style.color = "#d9d9d9";


            });


            var repText = document.createElement("a");
            repText.id ="report"
            repText.style.textDecoration = "none";
            repText.innerHTML = "View report"
            var fn = rows[i + 1].cells[6].innerHTML;
            var st = window.location.href;

            var baseUrl = st.split('/')[2];
            var url = "/report/"+ i+"/"+ids + "/" + fn;
            
            repText.href = url;
            rows[i + 1].cells[7].appendChild(repText)
        
            rows[i + 1].cells[7].style.color = "#0070C0";
            rows[i + 1].cells[7].style.fontWeight = "bold";
            rows[i + 1].cells[7].id = "report"

            rows[i + 1].cells[9].innerHTML = '<a href="{{ url_for("get_main") }}" style ="text-decoration:none;">Download</a>';
            rows[i + 1].cells[10].innerHTML = '<a href="{{ url_for("get_main") }}" style ="text-decoration:none;">Delete</a>';

            rows[i + 1].cells[9].style.fontWeight = "bold";
            rows[i + 1].cells[10].style.fontWeight = "bold";
            rows[i + 1].cells[9].style.color = "rgb(105, 125, 239)";
            rows[i + 1].cells[10].style.color = "rgb(224, 101, 101)";

       
            
        }

        var n = {{ n_files }};

        const registered = new Set();

        function poll() {
            fetch("/valprog/{{ id }}").then(function (r) { return r.json(); }).then(function (r) {
                var ids = '{{id}}';

  

                for (var i = 0; i < n; i++) {
                    var bar = document.getElementById("bar" + i.toString())
                    var percentage = document.getElementById("percentage" + i.toString())

                    var fn = r.filename;

                    if (r.progress[i] === 100) {

                        if (!registered.has(i)) {

                            registered.add(i);

                            bar.style.width = 100 * 2 + 'px';
                            percentage.innerHTML = "100%"
        
                            var rows = document.getElementsByTagName("table")[0].rows;
                            completeTable(i, r, ids, rows);

                        }

                    } else {
                        var p = r.progress[i];
                        if (p < 0) {
                            percentage.innerHTML = "<i>in queue</i>";
                            p = 0
                        } else {
                            percentage.innerHTML = p + "%";
                        }
                        bar.style.width = p * 2 + 'px';
                        
                    }

                }

                setTimeout(poll, 1000);

            });
        }

        poll();

    </script>

</body>

</html>